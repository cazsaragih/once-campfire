services:
  # Main web service running the Campfire application
  - type: web
    name: campfire
    env: docker
    dockerfilePath: ./Dockerfile
    dockerContext: .
    region: oregon
    plan: standard
    healthCheckPath: /up
    autoDeploy: true
    envVars:
      # Rails environment configuration
      - key: RAILS_ENV
        value: production
      - key: RAILS_LOG_TO_STDOUT
        value: true
      - key: RAILS_SERVE_STATIC_FILES
        value: true

      # SSL configuration (Render handles SSL termination)
      - key: DISABLE_SSL
        value: true

      # Server configuration
      - key: PORT
        value: 3000

      # Rails secret key (auto-generated by Render)
      - key: SECRET_KEY_BASE
        generateValue: true

      # Web Push notification keys (need to be set manually)
      - key: VAPID_PUBLIC_KEY
        sync: false
      - key: VAPID_PRIVATE_KEY
        sync: false

      # Redis connection (auto-injected from Redis service)
      - key: REDIS_URL
        fromService:
          name: campfire-redis
          type: redis
          property: connectionString

    # Persistent disk for SQLite database and file uploads
    disk:
      name: campfire-storage
      mountPath: /rails/storage
      sizeGB: 10

  # Managed Redis service for caching, ActionCable, and Resque
  - type: redis
    name: campfire-redis
    region: oregon
    plan: starter
    maxmemoryPolicy: allkeys-lru
    ipAllowList: []
